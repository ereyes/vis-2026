<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Text Analyzer & Frequent-Word Highlighter</title>

  <style>
    :root {
      --bg: #f6f7fb;
      --panel: #ffffff;
      --panel2: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: rgba(17, 24, 39, .12);
      --accent: #2f6fed;
      --danger: #e11d48;
      --ok: #16a34a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1000px 500px at 15% 0%, #eef2ff 0%, var(--bg) 55%),
        radial-gradient(900px 450px at 85% 10%, #ecfeff 0%, rgba(246,247,251,0) 60%),
        var(--bg);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 22px;
      letter-spacing: 0.2px;
    }

    .sub {
      margin: 0 0 16px;
      color: var(--muted);
      line-height: 1.45;
    }

    textarea {
      width: 100%;
      min-height: 200px;
      resize: vertical;
      padding: 14px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #ffffff;
      color: var(--text);
      outline: none;
      line-height: 1.45;
      font-size: 14px;
      box-shadow: 0 1px 2px rgba(17,24,39,.05);
    }

    textarea:focus {
      border-color: rgba(47,111,237,.55);
      box-shadow: 0 0 0 4px rgba(47,111,237,.16), 0 1px 2px rgba(17,24,39,.06);
    }

    .actions {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 650;
      letter-spacing: .2px;
      box-shadow: 0 1px 2px rgba(17,24,39,.05);
    }

    button:hover {
      border-color: rgba(17,24,39,.18);
      box-shadow: 0 2px 6px rgba(17,24,39,.08);
    }

    button:disabled {
      opacity: .55;
      cursor: not-allowed;
      box-shadow: none;
    }
    button:disabled:hover {
      border-color: var(--border);
      box-shadow: none;
    }

    button.primary {
      background: rgba(47,111,237,.10);
      border-color: rgba(47,111,237,.35);
    }

    button.primary:hover {
      background: rgba(47,111,237,.14);
      border-color: rgba(47,111,237,.45);
    }

    button.danger {
      background: rgba(225,29,72,.08);
      border-color: rgba(225,29,72,.30);
    }

    button.danger:hover {
      background: rgba(225,29,72,.12);
      border-color: rgba(225,29,72,.40);
    }

    .note {
      margin-left: auto;
      color: var(--muted);
      font-size: 12px;
    }

    .panels {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 1fr 1.25fr;
      gap: 14px;
      align-items: start;
    }

    .hidden { display: none !important; }

    .panel {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--panel);
      padding: 14px;
      box-shadow: 0 8px 24px rgba(17,24,39,.06);
    }

    .panel h2 {
      margin: 0 0 10px;
      font-size: 16px;
      letter-spacing: .2px;
    }

    .statsGrid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .stat {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 10px;
      background: #fbfcff;
    }

    .stat .label {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 4px;
    }

    .stat .value {
      font-size: 14px;
      font-weight: 750;
      word-break: break-word;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin: 8px 0;
    }

    input[type="text"], input[type="number"] {
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--text);
      padding: 10px 10px;
      border-radius: 10px;
      outline: none;
      font-size: 13px;
      box-shadow: 0 1px 2px rgba(17,24,39,.05);
    }

    input[type="text"]:focus, input[type="number"]:focus {
      border-color: rgba(47,111,237,.55);
      box-shadow: 0 0 0 4px rgba(47,111,237,.16), 0 1px 2px rgba(17,24,39,.06);
    }

    input[type="number"] { width: 110px; }

    label.small {
      color: var(--muted);
      font-size: 12px;
    }

    .checkboxRow {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0 6px;
      color: var(--muted);
      font-size: 12px;
      user-select: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0 10px;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(17,24,39,.08);
      font-size: 13px;
      text-align: left;
    }

    th {
      color: #4b5563;
      background: #f8fafc;
      font-weight: 750;
    }

    tr:last-child td { border-bottom: none; }

    td.num { text-align: right; font-variant-numeric: tabular-nums; }

    .wordList {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #ffffff;
      padding: 8px;
      max-height: 260px;
      overflow: auto;
    }

    .wordRow {
      display: grid;
      grid-template-columns: 22px 16px 1fr auto 28px;
      gap: 8px;
      align-items: center;
      padding: 6px 6px;
      border-radius: 10px;
    }

    .wordRow:hover { background: #f8fafc; }

    .swatch {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      border: 1px solid rgba(17,24,39,.16);
    }

    .wordText {
      font-weight: 700;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .wordCount {
      color: var(--muted);
      font-variant-numeric: tabular-nums;
      font-size: 12px;
      padding-left: 8px;
    }

    .removeBtn {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      border: 1px solid rgba(225,29,72,.35);
      background: rgba(225,29,72,.08);
      color: var(--text);
      cursor: pointer;
      font-weight: 900;
      line-height: 1;
    }

    .removeBtn:hover {
      border-color: rgba(225,29,72,.50);
      background: rgba(225,29,72,.12);
    }

    .hint {
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 10px;
      line-height: 1.45;
    }

    .highlightedText {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #ffffff;
      padding: 12px;
      white-space: pre-wrap;
      overflow: auto;
      max-height: 68vh;
      line-height: 1.55;
      font-size: 14px;
      box-shadow: inset 0 1px 0 rgba(17,24,39,.03);
    }

    .hl {
      padding: 0 3px;
      border-radius: 6px;
      box-decoration-break: clone;
      -webkit-box-decoration-break: clone;
      box-shadow: inset 0 0 0 1px rgba(17,24,39,.10);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--muted);
      font-size: 12px;
      box-shadow: 0 1px 2px rgba(17,24,39,.05);
    }

    .pill strong { color: var(--text); }

    @media (max-width: 980px) {
      .panels { grid-template-columns: 1fr; }
      .note { margin-left: 0; width: 100%; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Text Analyzer & Frequent-Word Highlighter</h1>
    <p class="sub">
      Paste text below and click <strong>Go</strong>. You will get basic statistics on the left and a highlighted view on the right.
      You can deactivate words that are not pertinent and add more frequent words to highlight.
    </p>

    <div class="row" style="margin-bottom: 10px;">
      <label class="small" for="textName">Text name</label>
      <input id="textName" type="text" placeholder="e.g., Q1_report_intro" style="flex: 1; min-width: 220px;" />
      <span class="note" style="margin-left: 0;">Used as a column in the CSV.</span>
    </div>

    <textarea id="inputText" placeholder="Paste text here..."></textarea>

    <div class="actions">
      <button id="goBtn" class="primary" type="button">Go</button>
      <button id="resetBtn" class="danger" type="button">Reset</button>
      <span class="note">Reading time uses 200 wpm. Readability uses a heuristic syllable counter.</span>
    </div>

    <div id="panels" class="panels hidden">
      <!-- LEFT -->
      <div class="panel">
        <h2>Statistics</h2>

        <div class="statsGrid">
          <div class="stat">
            <div class="label">Word count</div>
            <div class="value" id="wordCount">—</div>
          </div>
          <div class="stat">
            <div class="label">Unique words</div>
            <div class="value" id="uniqueCount">—</div>
          </div>
          <div class="stat">
            <div class="label">Sentence count</div>
            <div class="value" id="sentenceCount">—</div>
          </div>
          <div class="stat">
            <div class="label">Estimated reading time</div>
            <div class="value" id="readingTime">—</div>
          </div>
          <div class="stat">
            <div class="label">Flesch Reading Ease</div>
            <div class="value" id="readingEase">—</div>
          </div>
          <div class="stat">
            <div class="label">Flesch–Kincaid Grade</div>
            <div class="value" id="gradeLevel">—</div>
          </div>
          <div class="stat">
            <div class="label">Detected language (auto)</div>
            <div class="value" id="languageLabel">—</div>
          </div>
        </div>

        <div class="checkboxRow">
          <input id="excludeStopwords" type="checkbox" checked />
          <label for="excludeStopwords">Exclude stopwords (uses English or French list based on detection)</label>
        </div>

        <h2 style="margin-top: 10px;">10 most frequent words</h2>
        <table>
          <thead>
            <tr>
              <th style="width: 70%;">Word</th>
              <th class="num">Count</th>
            </tr>
          </thead>
          <tbody id="topWordsBody"></tbody>
        </table>

        <h2 style="margin-top: 10px;">Words to highlight</h2>

        <div class="row">
          <span class="pill">Currently active: <strong id="activeCount">0</strong></span>
          <span class="pill">In list: <strong id="listedCount">0</strong></span>
        </div>

        <div class="row">
          <label class="small" for="topNInput">Add top</label>
          <input id="topNInput" type="number" min="1" max="200" value="10" />
          <label class="small">words from the frequency ranking</label>
          <button id="addTopBtn" type="button">Add</button>
        </div>

        <div class="row">
          <input id="addWordInput" type="text" placeholder="Add a specific word (e.g., customer)" />
          <button id="addWordBtn" type="button">Add word</button>
        </div>

        <div id="wordList" class="wordList"></div>

        <div class="row" style="margin-top: 12px;">
          <button id="downloadCsvBtn" type="button" disabled>Download stats as CSV</button>
          <button id="copyTableBtn" type="button" disabled>Copy table</button>
          <span class="note" style="margin-left: 0;">Copy = TSV (ideal for Google Sheets).</span>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="panel">
        <h2>Highlighted text</h2>
        <div class="hint">
          Words selected on the left are highlighted here. Each word gets a consistent light background color.
          Toggle a word off if it is not pertinent.
        </div>
        <div id="highlightedText" class="highlightedText"></div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utilities ----------
    function supportsUnicodeProps() {
      try { new RegExp("\\p{L}", "u"); return true; } catch { return false; }
    }

    const HAS_UNICODE = supportsUnicodeProps();

    // Include straight and curly apostrophes
    const APO = "['’]";

    const wordRegex = HAS_UNICODE
      ? new RegExp(`[\\p{L}\\p{N}’']+`, "gu")
      : /[A-Za-z0-9'’]+/g;

    const tokenRegex = HAS_UNICODE
      ? new RegExp(`[\\p{L}\\p{N}’']+|[^\\p{L}\\p{N}’']+`, "gu")
      : /[A-Za-z0-9'’]+|[^A-Za-z0-9'’]+/g;

    const wordTokenTest = HAS_UNICODE
      ? new RegExp(`^[\\p{L}\\p{N}’']+$`, "u")
      : /^[A-Za-z0-9'’]+$/;

    const FR_ELISIONS = new Set(["l","d","j","t","s","n","m","c","qu","jusqu","lorsqu","puisqu"]);

    function trimApos(s) {
      return (s || "").replace(new RegExp(`^${APO}+|${APO}+$`, "g"), "");
    }

    function normalizeWord(raw, lang) {
      let w = (raw || "").toLowerCase();
      w = trimApos(w);

      // French elision handling: l’homme -> homme, c’est -> est, qu’il -> il
      if (lang === "fr") {
        const idx = w.search(new RegExp(APO));
        if (idx > 0) {
          const prefix = w.slice(0, idx);
          const rest = w.slice(idx + 1);
          if (FR_ELISIONS.has(prefix) && rest) w = rest;
        }
      }
      return w;
    }

    // For language detection, we apply the French-elision normalization because it improves detection
    function normalizeForDetection(raw) {
      let w = (raw || "").toLowerCase();
      w = trimApos(w);
      const idx = w.search(new RegExp(APO));
      if (idx > 0) {
        const prefix = w.slice(0, idx);
        const rest = w.slice(idx + 1);
        if (FR_ELISIONS.has(prefix) && rest) w = rest;
      }
      return w;
    }

    function escapeHtml(str) {
      return (str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function colorFromWord(word) {
      const s = String(word);
      let h = 0;
      for (let i = 0; i < s.length; i++) {
        h = (h * 31 + s.charCodeAt(i)) >>> 0;
      }
      const hue = h % 360;
      return `hsl(${hue} 55% 85%)`;
    }

    function formatReadingTime(wordCount, wpm = 200) {
      if (!wordCount) return "—";
      const minutes = wordCount / wpm;
      const totalSeconds = Math.round(minutes * 60);
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      if (m <= 0) return `${s}s (at ${wpm} wpm)`;
      if (s === 0) return `${m} min (at ${wpm} wpm)`;
      return `${m} min ${s}s (at ${wpm} wpm)`;
    }

    function round1(x) {
      return Math.round(x * 10) / 10;
    }

    function countSyllables(word) {
      let w = (word || "").toLowerCase();
      w = w.replace(/[^a-z]/g, "");
      if (!w) return 1;
      if (w.length <= 3) return 1;

      const vowels = "aeiouy";
      let count = 0;
      let prevVowel = false;

      for (let i = 0; i < w.length; i++) {
        const isVowel = vowels.includes(w[i]);
        if (isVowel && !prevVowel) count++;
        prevVowel = isVowel;
      }

      if (w.endsWith("e")) count--;
      if (w.endsWith("le") && w.length > 2) {
        const beforeL = w[w.length - 3];
        if (!vowels.includes(beforeL)) count++;
      }

      return Math.max(1, count);
    }

    function readingEaseLabel(score) {
      if (!isFinite(score)) return "—";
      if (score >= 90) return "Very easy";
      if (score >= 80) return "Easy";
      if (score >= 70) return "Fairly easy";
      if (score >= 60) return "Standard";
      if (score >= 50) return "Fairly difficult";
      if (score >= 30) return "Difficult";
      return "Very confusing";
    }

    // ---------- Stopwords ----------
    const STOPWORDS_EN = new Set([
      "a","an","and","are","as","at","be","but","by","for","if","in","into","is","it","no","not","of","on","or","such",
      "that","the","their","then","there","these","they","this","to","was","will","with","we","you","your","i","me","my",
      "our","us","he","him","his","she","her","hers","them","what","which","who","whom","where","when","why","how",
      "from","up","down","out","over","under","again","further","once","here","also","than","too","very","can","could",
      "should","would","may","might","must","do","does","did","done","have","has","had","having","been","being","were","am",
      "because","while","until","about","between","before","after","during","through","each","few","more","most","other",
      "some","any","both","all","own","same","so","just"
    ]);

    // Based on a common French stopword list (Snowball-style)
    const STOPWORDS_FR = new Set([
      "au","aux","avec","ce","ces","dans","de","des","du","elle","en","et","eux","il","je","la","le","leur","lui","ma","mais",
      "me","même","mes","moi","mon","ne","nos","notre","nous","on","ou","par","pas","pour","qu","que","qui","sa","se","ses",
      "son","sur","ta","te","tes","toi","ton","tu","un","une","vos","votre","vous","c","d","j","l","à","m","n","s","t","y",

      "été","étée","étées","étés","étant","suis","es","est","sommes","êtes","sont","serai","seras","sera","serons","serez",
      "seront","serais","serait","serions","seriez","seraient","étais","était","étions","étiez","étaient","fus","fut","fûmes",
      "fûtes","furent","sois","soit","soyons","soyez","soient","fusse","fusses","fût","fussions","fussiez","fussent",

      "ayant","eu","eue","eues","eus","ai","as","avons","avez","ont","aurai","auras","aura","aurons","aurez","auront","aurais",
      "aurait","aurions","auriez","auraient","avais","avait","avions","aviez","avaient","eut","eûmes","eûtes","eurent","aie",
      "aies","ait","ayons","ayez","aient","eusse","eusses","eût","eussions","eussiez","eussent",

      // extra very common French function words
      "ainsi","alors","après","assez","aussi","autre","avant","avec","avoir","bon","car","ceci","cela","celui","celle","celles",
      "ceux","chaque","chez","comme","comment","contre","deux","donc","dont","encore","entre","est","etait","était","être",
      "fait","faites","fois","grand","ici","jamais","juste","là","les","leurs","lors","lorsque","malgré","mieux","moins","mot",
      "moyen","ni","non","nos","nouveau","où","puis","quand","quel","quelle","quelles","quels","quelque","quelques","sans",
      "selon","sera","ses","seulement","si","sous","souvent","sur","tandis","tant","tes","tous","tout","toute","toutes",
      "très","trop","vers","voici","voilà"
    ]);

    function detectLanguage(text) {
      const tokens = (text.match(wordRegex) || []).slice(0, 2500);
      let enHits = 0;
      let frHits = 0;
      let accentHits = 0;

      const accentRe = /[àâäçéèêëîïôöùûüÿœæ]/i;

      for (const tok of tokens) {
        if (accentRe.test(tok)) accentHits++;
        const w = normalizeForDetection(tok);
        if (!w) continue;
        if (STOPWORDS_EN.has(w)) enHits++;
        if (STOPWORDS_FR.has(w)) frHits++;
      }

      // Scoring: accents are strong evidence for French; stopword hits are moderate evidence
      const frScore = frHits + (accentHits * 2);
      const enScore = enHits;

      // Guardrails to avoid switching to French on tiny samples
      if ((frScore >= enScore + 5) && (frHits >= 8 || accentHits >= 2)) return "fr";
      return "en";
    }

    function stopwordsFor(lang) {
      return lang === "fr" ? STOPWORDS_FR : STOPWORDS_EN;
    }

    // ---------- State ----------
    const state = {
      textName: "",
      text: "",
      language: "en",
      freq: new Map(),
      rankedWords: [],
      highlightList: [],
      activeSet: new Set(),
      colors: new Map(),
      excludeStopwords: true,
      metrics: null
    };

    // ---------- DOM ----------
    const el = {
      textName: document.getElementById("textName"),
      inputText: document.getElementById("inputText"),
      goBtn: document.getElementById("goBtn"),
      resetBtn: document.getElementById("resetBtn"),
      panels: document.getElementById("panels"),

      wordCount: document.getElementById("wordCount"),
      uniqueCount: document.getElementById("uniqueCount"),
      sentenceCount: document.getElementById("sentenceCount"),
      readingTime: document.getElementById("readingTime"),
      readingEase: document.getElementById("readingEase"),
      gradeLevel: document.getElementById("gradeLevel"),
      languageLabel: document.getElementById("languageLabel"),

      excludeStopwords: document.getElementById("excludeStopwords"),
      topWordsBody: document.getElementById("topWordsBody"),

      topNInput: document.getElementById("topNInput"),
      addTopBtn: document.getElementById("addTopBtn"),
      addWordInput: document.getElementById("addWordInput"),
      addWordBtn: document.getElementById("addWordBtn"),

      wordList: document.getElementById("wordList"),
      highlightedText: document.getElementById("highlightedText"),

      activeCount: document.getElementById("activeCount"),
      listedCount: document.getElementById("listedCount"),

      downloadCsvBtn: document.getElementById("downloadCsvBtn"),
      copyTableBtn: document.getElementById("copyTableBtn")
    };

    el.excludeStopwords.checked = true;

    function setLanguageFromText(text) {
      const lang = detectLanguage(text);
      state.language = lang;
      el.languageLabel.textContent = (lang === "fr") ? "French" : "English";
    }

    // ---------- Core analysis ----------
    function analyze(text) {
      const lang = state.language;
      const stopset = stopwordsFor(lang);

      const rawMatches = text.match(wordRegex) || [];
      const normalized = rawMatches.map(w => normalizeWord(w, lang)).filter(Boolean);

      const freq = new Map();
      for (const w of normalized) freq.set(w, (freq.get(w) || 0) + 1);

      const sentences = text
        .split(/[.!?]+/)
        .map(s => s.trim())
        .filter(s => s.length > 0);

      const sentenceCountRaw = sentences.length;
      const sentenceCountForFormula = Math.max(1, sentenceCountRaw);

      let syllables = 0;
      for (const w of normalized) syllables += countSyllables(w);

      const wordCount = normalized.length;
      const uniqueCount = freq.size;

      let ease = NaN, grade = NaN;
      if (wordCount > 0) {
        const wordsPerSentence = wordCount / sentenceCountForFormula;
        const syllablesPerWord = syllables / wordCount;
        ease = 206.835 - (1.015 * wordsPerSentence) - (84.6 * syllablesPerWord);
        grade = (0.39 * wordsPerSentence) + (11.8 * syllablesPerWord) - 15.59;
      }

      const wpm = 200;
      const readingTimeSeconds = wordCount > 0 ? Math.round((wordCount / wpm) * 60) : 0;
      const easeRounded = isFinite(ease) ? round1(ease) : null;
      const gradeRounded = isFinite(grade) ? round1(grade) : null;

      state.text = text;
      state.freq = freq;

      state.metrics = {
        wordCount,
        uniqueCount,
        sentenceCount: sentenceCountRaw,
        readingTimeWpm: wpm,
        readingTimeSeconds,
        readingTimeHuman: formatReadingTime(wordCount, wpm),
        readingEase: easeRounded,
        readingEaseLabel: easeRounded === null ? "—" : readingEaseLabel(easeRounded),
        fkGrade: gradeRounded,
        stopwordsExcluded: state.excludeStopwords,
        language: state.language
      };

      // Ranking list: stopwords are excluded here if checkbox is ON
      const ranked = [];
      for (const [word, count] of freq.entries()) {
        if (state.excludeStopwords && stopset.has(word)) continue;
        ranked.push({ word, count });
      }
      ranked.sort((a, b) => (b.count - a.count) || a.word.localeCompare(b.word));
      state.rankedWords = ranked;

      // UI stats
      el.wordCount.textContent = String(wordCount);
      el.uniqueCount.textContent = String(uniqueCount);
      el.sentenceCount.textContent = String(sentenceCountRaw);
      el.readingTime.textContent = state.metrics.readingTimeHuman;

      if (wordCount === 0) {
        el.readingEase.textContent = "—";
        el.gradeLevel.textContent = "—";
      } else {
        el.readingEase.textContent =
          state.metrics.readingEase === null
            ? "—"
            : `${state.metrics.readingEase} (${state.metrics.readingEaseLabel})`;
        el.gradeLevel.textContent = state.metrics.fkGrade === null ? "—" : String(state.metrics.fkGrade);
      }

      renderTop10();
    }

    function renderTop10() {
      const top10 = state.rankedWords.slice(0, 10);
      el.topWordsBody.innerHTML = "";

      if (top10.length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="2" style="color: var(--muted);">No words detected.</td>`;
        el.topWordsBody.appendChild(tr);
        return;
      }

      for (const item of top10) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(item.word)}</td>
          <td class="num">${item.count}</td>
        `;
        el.topWordsBody.appendChild(tr);
      }
    }

    // ---------- Highlight word list management ----------
    function ensureColor(word) {
      if (!state.colors.has(word)) state.colors.set(word, colorFromWord(word));
      return state.colors.get(word);
    }

    function addWordToHighlightList(word, active = true) {
      const w = normalizeWord(word, state.language);
      if (!w) return;

      if (!state.highlightList.includes(w)) state.highlightList.push(w);

      if (active) state.activeSet.add(w);
      else state.activeSet.delete(w);

      ensureColor(w);
      renderWordList();
      renderHighlightedText();
    }

    function removeWordFromHighlightList(word) {
      const w = normalizeWord(word, state.language);
      state.highlightList = state.highlightList.filter(x => x !== w);
      state.activeSet.delete(w);
      renderWordList();
      renderHighlightedText();
    }

    function addTopNToHighlightList(n) {
      const N = Math.max(1, Math.min(200, Number(n) || 10));
      const slice = state.rankedWords.slice(0, N);
      for (const item of slice) addWordToHighlightList(item.word, true);
    }

    function renderWordList() {
      el.wordList.innerHTML = "";

      const list = state.highlightList.slice();
      el.listedCount.textContent = String(list.length);
      el.activeCount.textContent = String(state.activeSet.size);

      if (list.length === 0) {
        const div = document.createElement("div");
        div.style.color = "var(--muted)";
        div.style.padding = "8px";
        div.textContent = "No words in the highlight list yet. Use “Add” or “Add word”.";
        el.wordList.appendChild(div);
        return;
      }

      for (const w of list) {
        const count = state.freq.get(w) || 0;
        const active = state.activeSet.has(w);
        const color = ensureColor(w);

        const row = document.createElement("div");
        row.className = "wordRow";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = active;
        cb.addEventListener("change", () => {
          if (cb.checked) state.activeSet.add(w);
          else state.activeSet.delete(w);
          el.activeCount.textContent = String(state.activeSet.size);
          renderHighlightedText();
        });

        const swatch = document.createElement("div");
        swatch.className = "swatch";
        swatch.style.background = color;

        const wordText = document.createElement("div");
        wordText.className = "wordText";
        wordText.title = w;
        wordText.textContent = w;

        const wordCount = document.createElement("div");
        wordCount.className = "wordCount";
        wordCount.textContent = String(count);

        const rm = document.createElement("button");
        rm.className = "removeBtn";
        rm.type = "button";
        rm.title = "Remove from list";
        rm.textContent = "×";
        rm.addEventListener("click", () => removeWordFromHighlightList(w));

        row.appendChild(cb);
        row.appendChild(swatch);
        row.appendChild(wordText);
        row.appendChild(wordCount);
        row.appendChild(rm);

        el.wordList.appendChild(row);
      }
    }

    // ---------- Highlight rendering ----------
    function renderHighlightedText() {
      const text = state.text || "";
      if (!text.trim()) {
        el.highlightedText.textContent = "";
        return;
      }

      const lang = state.language;
      const tokens = text.match(tokenRegex) || [text];
      let html = "";

      for (const tok of tokens) {
        if (wordTokenTest.test(tok)) {
          const norm = normalizeWord(tok, lang);
          if (norm && state.activeSet.has(norm)) {
            const bg = ensureColor(norm);
            html += `<span class="hl" style="background:${bg};">${escapeHtml(tok)}</span>`;
          } else {
            html += escapeHtml(tok);
          }
        } else {
          html += escapeHtml(tok);
        }
      }

      el.highlightedText.innerHTML = html;
    }

    // ---------- CSV + Copy ----------
    function csvCell(value) {
      const s = (value === null || value === undefined) ? "" : String(value);
      if (/[",\n\r]/.test(s)) return `"${s.replaceAll('"', '""')}"`;
      return s;
    }

    function sanitizeFilename(name) {
      return (name || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "_")
        .replace(/[^a-z0-9_-]+/g, "")
        .slice(0, 60);
    }

    function todayISO() {
      return new Date().toISOString().slice(0, 10);
    }

    async function writeClipboard(text) {
      // Modern API (may be blocked on file://)
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch (_) {}

      // Fallback
      try {
        const ta = document.createElement("textarea");
        ta.value = text;
        ta.setAttribute("readonly", "");
        ta.style.position = "fixed";
        ta.style.left = "-9999px";
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        ta.remove();
        return ok;
      } catch (_) {
        return false;
      }
    }

    function refreshAnalysisFromCurrentUI() {
      state.textName = (el.textName.value || "").trim();
      state.excludeStopwords = el.excludeStopwords.checked;

      // Language is based on current text (auto)
      setLanguageFromText(state.text);

      // Recompute rankings to guarantee exports match UI settings
      analyze(state.text);
    }

function tsvCell(value) {
  // Google Sheets paste-friendly:
  // remove tabs/newlines that would break cells/rows
  const s = (value === null || value === undefined) ? "" : String(value);
  return s.replace(/[\t\r\n]+/g, " ");
}

function buildStatsExportTable() {
  // Ensures language + stopwords + rankings are up-to-date and consistent
  refreshAnalysisFromCurrentUI();

  const m = state.metrics || {};
  const top10 = state.rankedWords.slice(0, 10);

  const header = [
    "text_name",
    "language",
    "word_count",
    "unique_words",
    "sentence_count",
    "reading_time_wpm",
    "reading_time_seconds",
    "reading_time_human",
    "flesch_reading_ease",
    "flesch_reading_ease_label",
    "flesch_kincaid_grade",
    "stopwords_excluded"
  ];

  for (let i = 1; i <= 10; i++) header.push(`top${i}_word`, `top${i}_count`);

  const row = [
    state.textName,
    m.language || state.language,
    m.wordCount ?? "",
    m.uniqueCount ?? "",
    m.sentenceCount ?? "",
    m.readingTimeWpm ?? 200,
    m.readingTimeSeconds ?? "",
    m.readingTimeHuman ?? "",
    m.readingEase ?? "",
    m.readingEaseLabel ?? "",
    m.fkGrade ?? "",
    m.stopwordsExcluded ? "true" : "false"
  ];

  for (let i = 0; i < 10; i++) {
    const item = top10[i];
    row.push(item ? item.word : "");
    row.push(item ? item.count : "");
  }

  return { header, row };
}

function downloadStatsCSV() {
  if (!state.text.trim()) {
    alert("Paste text and click Go first.");
    return;
  }

  const { header, row } = buildStatsExportTable();

  // CSV (with BOM for Excel compatibility)
  const csv =
    "\ufeff" +
    header.map(csvCell).join(",") +
    "\n" +
    row.map(csvCell).join(",") +
    "\n";

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });

  const base = sanitizeFilename(state.textName) || "text";
  const filename = `stats_${base}_${todayISO()}.csv`;

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function copyTopWordsTable() {
  // NOTE: Keeping the function name so you don't have to change event listeners.
  // This now copies the *same* export table as the CSV: header row + data row.

  if (!state.text.trim()) {
    alert("Paste text and click Go first.");
    return;
  }

  const { header, row } = buildStatsExportTable();

  // TSV is ideal for pasting into Google Sheets
  const tsv =
    header.map(tsvCell).join("\t") +
    "\n" +
    row.map(tsvCell).join("\t") +
    "\n";

  const ok = await writeClipboard(tsv);

  const original = el.copyTableBtn.textContent;
  if (ok) {
    el.copyTableBtn.textContent = "Copied";
    setTimeout(() => { el.copyTableBtn.textContent = original; }, 1200);
  } else {
    alert("Copy failed (browser restrictions). Try using the CSV download instead.");
  }
}


    // ---------- Actions ----------
    function run() {
      const text = el.inputText.value || "";
      state.textName = (el.textName.value || "").trim();
      state.excludeStopwords = el.excludeStopwords.checked;

      setLanguageFromText(text);
      analyze(text);

      el.panels.classList.remove("hidden");
      const enabled = !!text.trim();
      el.downloadCsvBtn.disabled = !enabled;
      el.copyTableBtn.disabled = !enabled;

      // Initialize highlight list with top 10 (based on current ranking)
      state.highlightList = [];
      state.activeSet = new Set();

      const initial = state.rankedWords.slice(0, 10);
      for (const item of initial) addWordToHighlightList(item.word, true);

      renderWordList();
      renderHighlightedText();
    }

    function resetAll() {
      el.textName.value = "";
      el.inputText.value = "";
      el.panels.classList.add("hidden");

      state.textName = "";
      state.text = "";
      state.language = "en";
      state.freq = new Map();
      state.rankedWords = [];
      state.highlightList = [];
      state.activeSet = new Set();
      state.colors = new Map();
      state.excludeStopwords = true;
      state.metrics = null;

      el.excludeStopwords.checked = true;
      el.languageLabel.textContent = "—";
      el.topWordsBody.innerHTML = "";
      el.wordList.innerHTML = "";
      el.highlightedText.textContent = "";

      el.wordCount.textContent = "—";
      el.uniqueCount.textContent = "—";
      el.sentenceCount.textContent = "—";
      el.readingTime.textContent = "—";
      el.readingEase.textContent = "—";
      el.gradeLevel.textContent = "—";
      el.activeCount.textContent = "0";
      el.listedCount.textContent = "0";

      el.downloadCsvBtn.disabled = true;
      el.copyTableBtn.disabled = true;
    }

    // ---------- Wire up ----------
    el.goBtn.addEventListener("click", run);
    el.resetBtn.addEventListener("click", resetAll);

    el.addTopBtn.addEventListener("click", () => {
      if (!state.text.trim()) return;
      addTopNToHighlightList(el.topNInput.value);
    });

    el.addWordBtn.addEventListener("click", () => {
      if (!state.text.trim()) return;
      const w = el.addWordInput.value.trim();
      el.addWordInput.value = "";
      addWordToHighlightList(w, true);
    });

    el.addWordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        el.addWordBtn.click();
      }
    });

    el.excludeStopwords.addEventListener("change", () => {
      if (!state.text.trim()) return;
      state.excludeStopwords = el.excludeStopwords.checked;
      setLanguageFromText(state.text);
      analyze(state.text);
      renderTop10();
    });

    el.downloadCsvBtn.addEventListener("click", downloadStatsCSV);
    el.copyTableBtn.addEventListener("click", copyTopWordsTable);
  </script>
</body>
</html>
